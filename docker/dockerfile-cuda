FROM nvidia/cuda:12.6.1-runtime-ubuntu24.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && apt install -y python3 python3-pip python3-wheel python3-venv python3-tk gcc libgl1 libglib2.0-0 sudo git \
    fonts-dejavu-core fonts-liberation fonts-noto-core fonts-ubuntu fontconfig

# Update font cache for better font detection
RUN fc-cache -fv
RUN useradd -ms /bin/bash dgenerate
RUN echo 'dgenerate:dgenerate' | chpasswd
RUN usermod -aG sudo dgenerate
RUN echo 'dgenerate ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Ensure proper permissions for dgenerate user home directory
RUN chown -R dgenerate:dgenerate /home/dgenerate
RUN chmod 755 /home/dgenerate

# Create necessary directories with proper permissions
RUN mkdir -p /home/dgenerate/.cache /home/dgenerate/.local /home/dgenerate/.config
RUN chown -R dgenerate:dgenerate /home/dgenerate/.cache /home/dgenerate/.local /home/dgenerate/.config
RUN chmod -R 755 /home/dgenerate/.cache /home/dgenerate/.local /home/dgenerate/.config

USER dgenerate
RUN git config --global --add safe.directory /opt/dgenerate
ENV DISPLAY=host.docker.internal:0.0
ENV PATH="/usr/local/cuda/bin:/home/dgenerate/.local/bin:$PATH"
ENV LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
WORKDIR "/opt/dgenerate"